<div class="container py-4" style="max-width: 1000px;">
    <!-- Card Principal de la Ruleta -->
    <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-primary text-white text-center py-4">
            <h1 class="mb-0 fw-bold">
                <i class="bi bi-bullseye me-2"></i>
                Ruleta de Categorías
            </h1>
            <p class="lead mb-0 mt-2 opacity-75">Gira la ruleta para descubrir tu categoría</p>
        </div>

        <div class="card-body p-4">
            <!-- Mensaje de categoría seleccionada -->
            <div id="mensajeCategoria" class="alert alert-info text-center mb-4" style="display: none;">
                <i class="bi bi-info-circle-fill me-2"></i>
                <span id="textoCategoria">Redirigiendo a la partida...</span>
            </div>

            <!-- Contenedor de la Ruleta -->
            <div class="text-center mb-4">
                <div class="position-relative d-inline-block">
                    <canvas id="ruleta" width="350" height="350"
                            class="shadow-lg border-4 border-white"
                            style="border-radius: 50%; border: 4px solid white; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
                    </canvas>
                </div>
            </div>

            <!-- Información del usuario -->
            {{#usuario}}
                <div class="row g-3 text-center mb-4">
                    <div class="col-12 col-md-4">
                        <div class="card border-0 shadow-sm bg-light">
                            <div class="card-body py-3">
                                <h6 class="text-primary mb-1">Puntos Acumulados</h6>
                                <h4 class="text-success fw-bold mb-0">{{puntos_acumulados}}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="card border-0 shadow-sm bg-light">
                            <div class="card-body py-3">
                                <h6 class="text-primary mb-1">Tu Nivel Actual</h6>
                                <h4 class="text-warning fw-bold mb-0">{{nivel}}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="card border-0 shadow-sm bg-light">
                            <div class="card-body py-3">
                                <h6 class="text-primary mb-1">Ronda Actual</h6>
                                <h4 class="text-info fw-bold mb-0">
                                    {{ronda_actual}}
                                </h4>
                            </div>
                        </div>
                    </div>
                </div>
            {{/usuario}}

            <!-- Indicador de carga -->
            <div id="cargando" class="text-center mt-4">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3 text-muted fs-5">
                    <i class="bi bi-gear-fill me-2"></i>
                    Preparando tu pregunta...
                </p>
            </div>

            <!-- Información adicional -->
            <div class="text-center mt-4">
                <div class="card border-0 bg-light">
                    <div class="card-body py-3">
                        <small class="text-muted">
                            <i class="bi bi-lightbulb-fill me-1"></i>
                            La ruleta seleccionará aleatoriamente una categoría para tu próxima pregunta
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones de acción -->
    <div class="text-center">
        <div class="d-grid gap-2 d-md-block">
            <a href="/user/lobby" class="btn btn-outline-primary btn-lg me-md-2 mb-2">
                <i class="bi bi-house-fill me-2"></i>
                Volver al Lobby
            </a>
        </div>
    </div>
</div>

<!-- Estilos CSS adicionales -->
<style>
    .card {
        border-radius: 16px;
        overflow: hidden;
    }

    #ruleta {
        transition: transform 0.3s ease;
    }

    .spinner-border {
        animation-duration: 1s;
    }

    .btn {
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .btn:hover {
        transform: translateY(-2px);
    }

    .border-4 {
        border-width: 4px !important;
    }

    @media (max-width: 768px) {
        #ruleta {
            width: 300px !important;
            height: 300px !important;
        }

        .container {
            padding-left: 15px;
            padding-right: 15px;
        }

        .btn-lg {
            width: 100%;
            margin-bottom: 10px;
        }
    }
</style>

<script>
    // Inicializar variables
    const categorias = [{{#categorias}}{
        nombre: "{{nombre}}",
        imagen: "{{imagen}}",
        color: "{{color}}"
    }{{^last}},{{/last}}{{/categorias}}].filter(cat => cat.nombre && cat.imagen && cat.color);

    const categoriaSeleccionada = "{{categoria_seleccionada}}";

    // Ocultar el spinner inicialmente (se mostrará durante el giro)
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('cargando').style.display = 'none';

        // Inicializar la ruleta después de que el DOM esté listo
        inicializarRuleta();
    });

    // CÓDIGO DE LA RULETA (integrado directamente)
    // Parámetros de la ruleta
    const canvas = document.getElementById("ruleta");
    const ctx = canvas.getContext("2d");
    const numSegments = categorias.length;
    const segmentAngle = 2 * Math.PI / numSegments;
    const radius = canvas.width / 2;

    let rotation = 0;

    // Función para dibujar la ruleta
    function drawRuleta() {
        // Fondo blanco para mejor contraste
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        for (let i = 0; i < numSegments; i++) {
            const angleStart = i * segmentAngle + rotation;
            const angleEnd = (i + 1) * segmentAngle + rotation;

            ctx.fillStyle = categorias[i].color;
            ctx.beginPath();
            ctx.arc(radius, radius, radius - 10, angleStart, angleEnd);
            ctx.lineTo(radius, radius);
            ctx.closePath();
            ctx.fill();

            // Borde blanco entre segmentos
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.fillStyle = "#fff";
            ctx.font = "bold 14px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.save();
            ctx.translate(radius, radius);
            ctx.rotate((angleStart + angleEnd) / 2);
            ctx.fillText(categorias[i].nombre, radius - 60, 0);
            ctx.restore();
        }

        // Centro de la ruleta
        ctx.fillStyle = '#f8f9fa';
        ctx.beginPath();
        ctx.arc(radius, radius, 15, 0, 2 * Math.PI);
        ctx.fill();
        ctx.strokeStyle = '#dee2e6';
        ctx.lineWidth = 3;
        ctx.stroke();
    }

    // Función para girar la ruleta automáticamente
    function girarRuletaAutomaticamente() {
        const spins = 5;
        const targetRotation = Math.random() * Math.PI * 2;
        const rotationIncrement = (Math.PI * 2 * spins + targetRotation - rotation) / 100;
        let currentRotation = rotation;
        let count = 0;

        // Mostrar spinner de carga
        document.getElementById('cargando').style.display = 'block';

        const animation = setInterval(() => {
            count++;
            currentRotation += rotationIncrement;
            rotation = currentRotation % (Math.PI * 2);
            drawRuleta();

            if (count >= 100) {
                clearInterval(animation);

                // Ocultar spinner
                document.getElementById('cargando').style.display = 'none';

                // Usar la categoría seleccionada que viene de PHP
                document.getElementById('mensajeCategoria').innerHTML =
                        "¡Categoría seleccionada: <strong>" + categoriaSeleccionada + "</strong>!";
                document.getElementById('mensajeCategoria').style.display = 'block';

                // Redirigir automáticamente después de 1.5 segundos
                setTimeout(() => {
                    window.location.href = '/game/jugarPartida';
                }, 1500);
            }
        }, 20);
    }

    // Función para inicializar la ruleta
    function inicializarRuleta() {
        // Dibujar la ruleta inicial
        drawRuleta();

        // Girar automáticamente después de un pequeño delay
        setTimeout(girarRuletaAutomaticamente, 1000);
    }
</script>